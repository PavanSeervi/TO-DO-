<!doctype html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Today • To-Do List (Fixed Edit/Delete)</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
      body {
        background: linear-gradient(135deg, #f8f9ff 0%, #e9ecff 100%);
        min-height: 100vh;
      }
      .card-task {
        transition:
          transform 0.25s ease,
          box-shadow 0.25s ease;
        border: none;
        border-radius: 14px;
        overflow: hidden;
      }
      .card-task:hover {
        transform: translateY(-5px);
        box-shadow: 0 14px 28px rgba(99, 102, 241, 0.18) !important;
      }
      .completed .card-title {
        text-decoration: line-through;
        opacity: 0.7;
      }
      .priority-high {
        border-left: 6px solid #dc3545;
      }
      .priority-medium {
        border-left: 6px solid #fd7e14;
      }
      .priority-low {
        border-left: 6px solid #0d6efd;
      }
      .priority-none {
        border-left: 6px solid #6c757d;
      }
      .toast-container {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 1055;
      }
      .sortable-drag {
        transform: scale(1.04) !important;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25) !important;
        opacity: 0.92;
        z-index: 1000;
      }
      .sortable-chosen {
        opacity: 0.7;
      }
      .sortable-ghost {
        background: #e9ecef !important;
        border: 2px dashed #adb5bd;
        opacity: 0.6;
      }
      .dragging-active body {
        overflow: hidden;
      }
    </style>
  </head>
  <body class="py-5 px-3 px-md-4">
    <div class="container" style="max-width: 780px">
      <h1 class="text-center mb-5 fw-bold text-primary display-5">Today</h1>

      <div class="card shadow border-0 rounded-4 mb-5">
        <div class="card-body p-4 p-md-5">
          <form id="add-form" class="row g-3 align-items-center">
            <div class="col-12 col-md">
              <input
                type="text"
                id="task-input"
                class="form-control form-control-lg"
                placeholder="What needs to be done?"
                autofocus
                required
              />
            </div>
            <div class="col-12 col-sm-6 col-md-4">
              <input
                type="date"
                id="due-date"
                class="form-control form-control-lg"
              />
            </div>
            <div class="col-12 col-sm-6 col-md-3">
              <select id="priority" class="form-select form-select-lg">
                <option value="none">Priority: None</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="col-12 col-md-2 d-grid">
              <button type="submit" class="btn btn-primary btn-lg">Add</button>
            </div>
          </form>
        </div>
      </div>

      <div id="task-list" class="d-flex flex-column gap-3"></div>

      <div id="empty-state" class="text-center py-5 my-5 text-muted d-none">
        <i class="bi bi-list-check fs-1 mb-3 d-block"></i>
        <h4 class="mb-2">All clear for now</h4>
        <p class="lead">Add tasks — long-press & drag to reorder!</p>
      </div>
    </div>

    <div class="toast-container">
      <div
        id="liveToast"
        class="toast bg-dark text-white border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body fs-5"></div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      const tasks = JSON.parse(localStorage.getItem("tasks")) || [];
      let editingIndex = -1;

      const toastEl = document.getElementById("liveToast");
      const toastBody = toastEl.querySelector(".toast-body");
      const bsToast = new bootstrap.Toast(toastEl);

      function showToast(msg) {
        toastBody.textContent = msg;
        bsToast.show();
      }

      function saveTasks() {
        localStorage.setItem("tasks", JSON.stringify(tasks));
      }

      function getPriorityValue(p) {
        const order = { high: 0, medium: 1, low: 2, none: 3 };
        return order[p] ?? 3;
      }

      function getDueSortValue(task) {
        return task.dueDate || "9999-99-99";
      }

      function renderTasks() {
        const container = document.getElementById("task-list");
        const empty = document.getElementById("empty-state");
        container.innerHTML = "";

        const today = new Date().toISOString().split("T")[0];

        const sorted = [...tasks].sort((a, b) => {
          if (a.completed !== b.completed) return a.completed ? 1 : -1;
          const priDiff =
            getPriorityValue(a.priority) - getPriorityValue(b.priority);
          if (priDiff !== 0) return priDiff;
          return getDueSortValue(a).localeCompare(getDueSortValue(b));
        });

        sorted.forEach((task, sortedIdx) => {
          const idx = tasks.indexOf(task);
          const isEditing = editingIndex === idx;
          const priorityClass = `priority-${task.priority || "none"}`;
          const dueClass = task.dueDate
            ? task.dueDate < today
              ? "bg-danger"
              : task.dueDate === today
                ? "bg-warning text-dark"
                : "bg-success"
            : "bg-secondary";

          const dueText = task.dueDate
            ? task.dueDate < today
              ? `Overdue ${task.dueDate}`
              : task.dueDate === today
                ? "Today"
                : `Due ${task.dueDate}`
            : "No due date";

          const card = document.createElement("div");
          card.className = `card card-task shadow-sm ${priorityClass} ${task.completed ? "completed bg-light-subtle" : ""}`;
          card.dataset.index = idx;

          if (isEditing) {
            card.innerHTML = `
        <div class="card-body p-4">
          <div class="d-flex flex-column gap-3">
            <input type="text" class="form-control form-control-lg" id="edit-title-${idx}" value="${task.title.replace(/"/g, "&quot;")}">
            <div class="row g-3">
              <div class="col-12 col-sm-6">
                <input type="date" class="form-control form-control-lg" id="edit-date-${idx}" value="${task.dueDate || ""}">
              </div>
              <div class="col-12 col-sm-6">
                <select class="form-select form-select-lg" id="edit-priority-${idx}">
                  <option value="none" ${!task.priority || task.priority === "none" ? "selected" : ""}>None</option>
                  <option value="low" ${task.priority === "low" ? "selected" : ""}>Low</option>
                  <option value="medium" ${task.priority === "medium" ? "selected" : ""}>Medium</option>
                  <option value="high" ${task.priority === "high" ? "selected" : ""}>High</option>
                </select>
              </div>
            </div>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-success flex-fill py-3 edit-save-btn" data-index="${idx}">Save</button>
              <button class="btn btn-outline-secondary flex-fill py-3 edit-cancel-btn" data-index="${idx}">Cancel</button>
            </div>
          </div>
        </div>
      `;
          } else {
            card.innerHTML = `
        <div class="card-body p-4 d-flex align-items-center gap-4">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" style="width: 3.2em; height: 1.6em;" 
                   ${task.completed ? "checked" : ""} data-index="${idx}" data-action="toggle">
          </div>
          <div class="flex-grow-1">
            <h5 class="card-title mb-2">${task.title}</h5>
            <div class="d-flex flex-wrap gap-2">
              <span class="badge ${dueClass} rounded-pill px-3 py-2">${dueText}</span>
              <span class="badge bg-info rounded-pill px-3 py-2">
                ${task.priority ? task.priority.charAt(0).toUpperCase() + task.priority.slice(1) : "No priority"}
              </span>
            </div>
          </div>
          <div class="btn-group" role="group">
            <button class="btn btn-outline-primary px-4 edit-btn" data-index="${idx}">Edit</button>
            <button class="btn btn-outline-danger px-4 delete-btn" data-index="${idx}">Delete</button>
          </div>
        </div>
      `;
          }

          container.appendChild(card);
        });

        empty.classList.toggle("d-none", tasks.length > 0);

        // SortableJS (mobile tuned)
        new Sortable(container, {
          animation: 180,
          easing: "cubic-bezier(0.34, 1.56, 0.64, 1)",
          handle: ".card-body",
          ghostClass: "sortable-ghost",
          chosenClass: "sortable-chosen",
          dragClass: "sortable-drag",
          fallbackTolerance: 3,
          delay: 180,
          delayOnTouchOnly: true,
          touchStartThreshold: 4,
          forceFallback: true,
          scroll: true,
          scrollSensitivity: 40,
          scrollSpeed: 12,
          bubbleScroll: true,
          filter: ".btn, input, select, .form-check-input",
          preventOnFilter: true,

          onStart: () => document.body.classList.add("dragging-active"),
          onEnd: (evt) => {
            document.body.classList.remove("dragging-active");
            const oldIdx = evt.oldIndex;
            const newIdx = evt.newIndex;
            const moved = tasks.splice(oldIdx, 1)[0];
            tasks.splice(newIdx, 0, moved);
            saveTasks();
            renderTasks();
            showToast("Order updated");
          },
        });
      }

      // ─── Event Delegation (this fixes Edit/Delete after drag) ────────────────
      document
        .getElementById("task-list")
        .addEventListener("click", function (e) {
          const target = e.target;

          // Delete button
          if (target.classList.contains("delete-btn")) {
            const idx = parseInt(target.dataset.index);
            if (!isNaN(idx) && confirm("Delete this task?")) {
              if (editingIndex === idx) cancelEdit();
              tasks.splice(idx, 1);
              saveTasks();
              renderTasks();
              showToast("Task deleted");
            }
            return;
          }

          // Edit button
          if (target.classList.contains("edit-btn")) {
            const idx = parseInt(target.dataset.index);
            if (!isNaN(idx)) {
              editingIndex = idx;
              renderTasks();
              setTimeout(
                () => document.getElementById(`edit-title-${idx}`)?.focus(),
                150,
              );
            }
            return;
          }

          // Save in edit mode
          if (target.classList.contains("edit-save-btn")) {
            const idx = parseInt(target.dataset.index);
            if (!isNaN(idx)) saveEdit(idx);
            return;
          }

          // Cancel in edit mode
          if (target.classList.contains("edit-cancel-btn")) {
            cancelEdit();
            return;
          }
        });

      // Toggle uses change event (checkbox)
      document
        .getElementById("task-list")
        .addEventListener("change", function (e) {
          if (e.target.matches('.form-check-input[data-action="toggle"]')) {
            const idx = parseInt(e.target.dataset.index);
            if (!isNaN(idx)) {
              tasks[idx].completed = !tasks[idx].completed;
              saveTasks();
              renderTasks();
            }
          }
        });

      // ─── Core Functions ──────────────────────────────────────────────────────
      function addTask(e) {
        e.preventDefault();
        const title = document.getElementById("task-input").value.trim();
        const due = document.getElementById("due-date").value;
        const prio = document.getElementById("priority").value;

        if (!title) return showToast("Enter a task title");

        tasks.push({
          title,
          dueDate: due || null,
          priority: prio === "none" ? null : prio,
          completed: false,
        });

        document.getElementById("task-input").value = "";
        document.getElementById("due-date").value = "";
        document.getElementById("priority").value = "none";
        saveTasks();
        renderTasks();
        showToast("Task added");
      }

      function saveEdit(idx) {
        const title = document
          .getElementById(`edit-title-${idx}`)
          ?.value.trim();
        const due = document.getElementById(`edit-date-${idx}`)?.value;
        const prio = document.getElementById(`edit-priority-${idx}`)?.value;

        if (!title) return showToast("Title required");

        tasks[idx].title = title;
        tasks[idx].dueDate = due || null;
        tasks[idx].priority = prio === "none" ? null : prio;
        editingIndex = -1;
        saveTasks();
        renderTasks();
        showToast("Task saved");
      }

      function cancelEdit() {
        editingIndex = -1;
        renderTasks();
      }

      document.getElementById("add-form").addEventListener("submit", addTask);

      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && editingIndex !== -1) {
          e.preventDefault();
          saveEdit(editingIndex);
        }
      });

      // Init
      renderTasks();
      document.getElementById("task-input").focus();
    </script>
  </body>
</html>
